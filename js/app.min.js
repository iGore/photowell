// Generated by CoffeeScript 1.4.0
/*
Facebook init
*/

var AlbumsCtrl, FriendsCtrl, MetaCtrl, Photowell, StreamCtrl, UserCtrl;

FB.init({
  appId: '544498978935917',
  frictionlessRequests: true,
  status: true,
  cookie: true
});

/*
DOM ready
*/


angular.element(document).ready(function() {
  return $('.fancybox').fancybox({
    openEffect: 'elastic',
    closeEffect: 'elastic',
    helpers: {
      title: {
        type: 'over'
      }
    }
  });
});

/*
App: Photowell
*/


Photowell = angular.module('Photowell', []);

/*
Routes
*/


Photowell.config(function($routeProvider) {
  return $routeProvider.when('/', {
    controller: UserCtrl,
    templateUrl: 'views/user.html'
  }).when('/stream', {
    controller: StreamCtrl,
    templateUrl: 'views/stream.html'
  }).when('/friends', {
    controller: FriendsCtrl,
    templateUrl: 'views/friends.html'
  }).when('/albums', {
    controller: AlbumsCtrl,
    templateUrl: 'views/albums.html'
  }).otherwise({
    redirectTo: '/'
  });
});

/*
Globale Funktionen
*/


Photowell.run(function($rootScope, Monitor) {
  $rootScope.monitor = Monitor;
  $rootScope.needLoad = function() {
    return $(window).scrollTop() >= ($(document).height() - $(window).height()) * 0.9;
  };
  $rootScope.hasScrollBar = function() {
    return $(document).height() !== $('.scroll').height() + $('.scroll').scrollTop();
  };
  return $rootScope.formatImage = function(image) {
    var source;
    if (image.images[4] >= 320) {
      source = image.images[4].source;
    } else if (image.images[3] >= 320) {
      source = image.images[3].source;
    } else {
      source = image.images[2].source;
    }
    return {
      src: source,
      src_large: image.images[0].source,
      name: image.name != null ? image.name : void 0
    };
  };
});

/*
User factory
*/


Photowell.factory('User', function($rootScope) {
  var storage;
  storage = {
    name: '',
    username: '',
    picture: '',
    access_token: '',
    user_photos: [],
    user_photos_data: [],
    user_photos_data_raw: []
  };
  return {
    set: function(key, value, broadcast) {
      if (broadcast == null) {
        broadcast = true;
      }
      storage[key] = value;
      if (broadcast) {
        $rootScope.$broadcast(key, value);
      }
      return this;
    },
    push: function(key, value, broadcast) {
      if (broadcast == null) {
        broadcast = true;
      }
      storage[key].push(value);
      if (broadcast) {
        $rootScope.$broadcast(key, value);
      }
      return this;
    },
    merge: function(key, value, broadcast) {
      if (broadcast == null) {
        broadcast = true;
      }
      $.merge(storage[key], value);
      if (broadcast) {
        $rootScope.$broadcast(key, value);
      }
      return this;
    },
    get: function(key) {
      return storage[key];
    }
  };
});

/*
Friends factory
*/


Photowell.factory('Friends', function($rootScope, $timeout, User, Albums) {
  var storage;
  storage = {
    friends_photos: [],
    friends_photos_data: [],
    friends_photos_data_raw: []
  };
  return {
    set: function(key, value, broadcast) {
      if (broadcast == null) {
        broadcast = true;
      }
      storage[key] = value;
      if (broadcast) {
        $rootScope.$broadcast(key, value);
      }
      return this;
    },
    push: function(key, value, broadcast) {
      if (broadcast == null) {
        broadcast = true;
      }
      storage[key].push(value);
      if (broadcast) {
        $rootScope.$broadcast(key, value);
      }
      return this;
    },
    merge: function(key, value, broadcast) {
      if (broadcast == null) {
        broadcast = true;
      }
      $.merge(storage[key], value);
      if (broadcast) {
        $rootScope.$broadcast(key, value);
      }
      return this;
    },
    get: function(key) {
      return storage[key];
    },
    check: function() {
      if (($rootScope.needLoad() || !$rootScope.hasScrollBar()) && !$rootScope.monitor.get('in_process')) {
        if (this.get('friends_photos_data').length === 0) {
          if (this.get('friends_photos_data_raw').length === 0) {
            return;
          }
          this.merge('friends_photos_data', $.map(this.get('friends_photos_data_raw'), function(photo) {
            return $rootScope.formatImage(photo);
          }), false);
          this.set('friends_photos_data_raw', [], false);
        }
        $rootScope.monitor.set('in_process', true);
        this.merge('friends_photos', this.get('friends_photos_data').slice(0, 21));
        this.set('friends_photos_data', this.get('friends_photos_data').slice(20), false);
        return angular.forEach(this.get('friends_photos_data').slice(0, 21), function(img) {
          return (new Image()).src = img.src;
        });
      }
    }
  };
});

/*
Albums factory
*/


Photowell.factory('Albums', function($rootScope, Monitor) {
  var storage;
  storage = {
    albums_photos: [],
    albums_photos_data: [],
    albums_photos_data_raw: []
  };
  return {
    set: function(key, value, broadcast) {
      if (broadcast == null) {
        broadcast = true;
      }
      storage[key] = value;
      if (broadcast) {
        $rootScope.$broadcast(key, value);
      }
      return this;
    },
    push: function(key, value, broadcast) {
      if (broadcast == null) {
        broadcast = true;
      }
      storage[key].push(value);
      if (broadcast) {
        $rootScope.$broadcast(key, value);
      }
      return this;
    },
    merge: function(key, value, broadcast) {
      if (broadcast == null) {
        broadcast = true;
      }
      $.merge(storage[key], value);
      if (broadcast) {
        $rootScope.$broadcast(key, value);
      }
      return this;
    },
    get: function(key) {
      return storage[key];
    },
    check: function() {
      if (($rootScope.needLoad() || !$rootScope.hasScrollBar()) && !$rootScope.monitor.get('in_process')) {
        if (this.get('albums_photos_data').length === 0) {
          if (this.get('albums_photos_data_raw').length === 0) {
            return;
          }
          this.merge('albums_photos_data', $.map(this.get('albums_photos_data_raw'), function(photo) {
            return $rootScope.formatImage(photo);
          }));
          this.set('albums_photos_data_raw', [], false);
        }
        $rootScope.monitor.set('in_process', true);
        this.merge('albums_photos', this.get('albums_photos_data').slice(0, 21));
        this.set('albums_photos_data', this.get('albums_photos_data').slice(20), false);
        return angular.forEach(this.get('albums_photos_data').slice(0, 21), function(img) {
          return (new Image()).src = img.src;
        });
      }
    }
  };
});

/*
Overlay factory

Speichert das Overlay Element, so das es nur einmal vorhanden ist und 
von allen Controllern benutzt werden kann.
*/


Photowell.factory('Overlay', function($rootScope) {
  var overlay;
  overlay = null;
  return {
    set: function(value) {
      overlay = value;
      return this;
    },
    get: function() {
      return overlay;
    }
  };
});

/*
Monitor factory

Stellt Monitor Objekte bereit um eine Synchrone
*/


Photowell.factory('Monitor', function($rootScope) {
  var monitor;
  monitor = {
    'in_process': false
  };
  return {
    set: function(key, value) {
      monitor[key] = value;
      return this;
    },
    get: function(key) {
      return monitor[key];
    }
  };
});

/*
Directive: photo-wall

Ein Directive welches dazu dient, nach dem aufbau des DOM's, die 
Bilder neu anzuordnen bzw. die neu dazugekommen Bilder unten richtig anordnen.
*/


Photowell.directive('photoWall', function($rootScope, $timeout) {
  return function(scope, element, attr) {
    if (!scope.$last) {
      return;
    }
    return $timeout(function() {
      scope.container.freetile({
        animate: true
      });
      return $rootScope.monitor.set('in_process', false);
    });
  };
});

/*
Directive: when-scrolled

Ein Directive an dem das scroll-Event angeh√§gt ist.
*/


Photowell.directive('whenScrolled', function() {
  return function(scope, elm, attr) {
    var scrollCheck;
    scrollCheck = function(evt) {
      console.log(scope.factory);
      return scope.factory.check();
    };
    return elm.bind('scroll load', scrollCheck);
  };
});

/*
Meta Controller
*/


MetaCtrl = function($scope, $location, $timeout, User, Friends, Albums, Overlay) {
  Overlay.set($('.overlay'));
  FB.getLoginStatus(function(response) {
    if (response.status === 'connected') {
      return User.set('access_token', response.authResponse.accessToken);
    } else {
      $scope.$apply(function() {
        if ($location.$$path !== '/') {
          return $location.path('/');
        }
      });
      return Overlay.get().fadeIn();
    }
  });
  $scope.login = function() {
    return FB.login(function(response) {
      if (response.authResponse) {
        return User.set('access_token', response.authResponse.accessToken);
      }
    }, {
      scope: 'email,user_photos,friends_photos,user_photo_video_tags,friends_photo_video_tags'
    });
  };
  $scope.init = function() {
    return FB.api('/me?fields=name,username,albums.fields(photos.fields(name,images)),friends.fields(id),photos,picture.type(large)&access_token=' + User.get('access_token'), function(user) {
      var int;
      User.set('picture', user.picture.data.url);
      User.set('name', user.name);
      User.set('username', user.username);
      User.set('user_photos_data_raw', user.photos.data);
      angular.forEach(user.albums.data, function(album) {
        return User.merge('user_photos_data_raw', album.photos.data);
      });
      int = setInterval(function() {
        if (user.friends.data.length === 0) {
          return clearInterval(int);
        }
        return FB.api('/' + user.friends.data.pop().id + '?fields=name,images,photos,albums.fields(photos.fields(name,images))&access_token=' + User.get('access_token'), function(friend) {
          if (friend.photos != null) {
            Friends.merge('friends_photos_data_raw', friend.photos.data);
          }
          if (friend.albums != null) {
            return angular.forEach(friend.albums.data, function(album) {
              if (album.photos != null) {
                return Albums.merge('albums_photos_data_raw', album.photos.data);
              }
            });
          }
        });
      }, 1000);
      return Overlay.get().fadeOut('slow');
    });
  };
  $scope.$on('name', function(events, name) {
    return $scope.$apply(function() {
      return $scope.name = name;
    });
  });
  return $scope.$on('access_token', function() {
    return $scope.init();
  });
};

/*
User Controller
*/


UserCtrl = function($scope, User, Monitor) {
  $scope.container = $('.container');
  $scope.monitor = Monitor.set('in_process', false);
  $scope.name = User.get('name');
  $scope.username = User.get('username');
  $scope.picture = User.get('picture');
  $scope.photos = User.get('user_photos');
  $scope.preprocess = function() {
    User.merge('user_photos_data', $.map(User.get('user_photos_data_raw'), function(photo) {
      return $scope.formatImage(photo);
    }));
    return User.set('user_photos_data_raw', [], false);
  };
  $scope.check = function() {
    if (($scope.needLoad() || !$scope.hasScrollBar()) && !$scope.monitor.get('in_process')) {
      if (User.get('user_photos_data').length === 0) {
        return;
      }
      $scope.monitor.set('in_process', true);
      User.merge('user_photos', User.get('user_photos_data').slice(0, 21));
      User.set('user_photos_data', User.get('user_photos_data').slice(20), false);
      return angular.forEach(User.get('user_photos_data').slice(0, 21), function(img) {
        return (new Image()).src = img.src;
      });
    }
  };
  $scope.$on('name', function(events, name) {
    return $scope.$apply(function() {
      return $scope.name = name;
    });
  });
  $scope.$on('username', function(events, username) {
    return $scope.$apply(function() {
      return $scope.username = username;
    });
  });
  $scope.$on('picture', function(events, picture) {
    return $scope.$apply(function() {
      return $scope.picture = picture;
    });
  });
  $scope.$on('user_photos', function() {
    if (!$scope.$$phase) {
      return $scope.$apply();
    }
  });
  $scope.$on('user_photos_data', function() {
    return $scope.check();
  });
  $scope.$on('user_photos_data_raw', function() {
    return $scope.preprocess();
  });
  if (User.get('user_photos_data').length !== 0) {
    $scope.check();
  }
  if (User.get('user_photos_data_raw').length !== 0) {
    return $scope.preprocess();
  }
};

/*
Stream Controller
*/


StreamCtrl = function($scope, User) {};

/*
Friends Controller
*/


FriendsCtrl = function($scope, User, Friends, Albums, Monitor) {
  $scope.container = $('.container');
  $scope.factory = Friends;
  $scope.images = Friends.get('friends_photos');
  /*
      $scope.preprocess = ->
          friends_photos_data_raw = Friends.get('friends_photos_data_raw')
          Friends.set 'friends_photos_data_raw', [], false
  
          Friends.merge 'friends_photos_data', $.map friends_photos_data_raw, (photo)-> $scope.formatImage photo
  
      $scope.check = ->
          if ($scope.needLoad() or not $scope.hasScrollBar()) and not $scope.monitor.get 'in_process'
              return if Friends.get('friends_photos_data').length is 0
  
              $scope.monitor.set 'in_process', yes
  
              Friends.merge 'friends_photos', Friends.get('friends_photos_data')[0..20]
  
              Friends.set 'friends_photos_data', Friends.get('friends_photos_data')[20..], false
  
              # preload
              angular.forEach Friends.get('friends_photos_data')[0..20], (img)-> (new Image()).src = img.src
  */

  $scope.$on('friends_photos', function() {
    if (!$scope.$$phase) {
      return $scope.$apply();
    }
  });
  /*
      $scope.$on 'friends_photos_data', -> 
          $scope.check()
  
      $scope.check() if Friends.get('friends_photos_data').length isnt 0
  */

  /*
  */

  $scope.$on('friends_photos_data_raw', function() {
    return $scope.factory.check();
  });
  if (Friends.get('friends_photos_data_raw').length !== 0) {
    return $scope.factory.check();
  }
};

/*
Album Controller
*/


AlbumsCtrl = function($scope, User, Albums, Friends, Monitor) {
  $scope.container = $('.container');
  $scope.factory = Albums;
  $scope.photos = Albums.get('albums_photos');
  /*
      $scope.preprocess = ->
          albums_photos_data_raw = Albums.get('albums_photos_data_raw')
          Albums.set 'albums_photos_data_raw', [], false
  
          Albums.merge 'albums_photos_data', $.map albums_photos_data_raw, (photo)-> $scope.formatImage photo
  
      $scope.check = ->
          if ($scope.needLoad() or not $scope.hasScrollBar()) and not $scope.monitor.get 'in_process'
              return if Albums.get('albums_photos_data').length is 0
  
              $scope.monitor.set 'in_process', yes
  
              Albums.merge 'albums_photos', Albums.get('albums_photos_data')[0..20]
  
              Albums.set 'albums_photos_data', Albums.get('albums_photos_data')[20..], false
  
              # preload
              angular.forEach Albums.get('albums_photos_data')[0..20], (img)-> (new Image()).src = img.src
  */

  $scope.$on('albums_photos', function() {
    if (!$scope.$$phase) {
      return $scope.$apply();
    }
  });
  /*
      $scope.$on 'albums_photos_data', -> 
          console.log 'Test'
          $scope.factory.check()
  
      $scope.factory.check() if Albums.get('albums_photos_data').length isnt 0
  */

  $scope.$on('albums_photos_data_raw', function() {
    return $scope.factory.check();
  });
  if (Albums.get('albums_photos_data_raw').length !== 0) {
    return $scope.factory.check();
  }
};

